<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>test starting page</title>
    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <link rel="stylesheet" href="css/gamepage.css">
    <link rel="stylesheet" href="css/fonts.css">

    <style>

        /*// question_section //*/
        .question_section {
            display: block;
        }
        .question_box {
            min-height: 500px;
            justify-content: flex-end;
            text-align: center;
            font-family: 'KccHanbit', sans-serif;
        }
        .question_box h4{
            font-size:1.0rem;
            font-weight: normal;
            margin: 0;
        }
        .question_box h3 {
            font-size:1.6rem;
            font-weight: normal;
            margin: 0;
        }
        .question_board {
            height:405px; width: 100%; 
            margin-bottom: 80px;
            display:flex; flex-direction:column;  justify-content: space-between; align-items: center; gap :20px;
        }
        .question_progress {
            width: 100%;
            height: 42px;
            display:flex; flex-direction: column; justify-content: space-between; align-items: center;
        }
        .progress_bar {
            position: relative;
            height: 8px;
            min-width: 520px;
            width: 90vw;
            max-width: 1340px;
            background: rgba(255,255,255,0.6);
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .progress_fill {
            position: relative;
            height: 100%;
            --p: 0; /* 진행률 변수 */
            width: 100%;
            background: linear-gradient(90deg, #3ca7ff, #ffb6f0);
            background-size: 100% 100%;
            clip-path: inset(0 calc((1 - var(--p))* 100%) 0 0 round 10px);
            transition: clip-path .5s ease;   /* 애니메이션 */
            overflow: hidden;
            border-radius: 10px;
            /*transition: width 0.5s ease;*/
        }
        .question_content {
            width: 100%;
            height: 240px;
            display:flex; flex-direction:column; justify-content: center; align-items: center;
            background-color: rgba(255, 255, 255, 0.4);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* answer_box */
        .next_box {
            margin-top: 50px;
            margin-bottom: auto;
            width: fit-content;
            height: fit-content;
        }
        .next_button {
            height: 45px; width: 110px;
            font-size: 0.8rem;
            font-weight: 400;
            cursor: pointer;
            border-radius: 10px;
            border: none;
            background-color: rgba(255, 255, 255, 0.7);
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        .next_button:disabled {         /* 비활성화 스타일 */
            box-shadow: none;
            background-color: rgba(255, 255, 255, 0.4);
            color: gray;
            border: none;
            cursor: not-allowed;
        }
        .next_button:not(:disabled):active {    /* 활성화됐을 때 클릭 시 효과 */
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.1);
        }
        
        .answer_box {
            min-height: 400px;
        }
        .answer1, .answer2 {
            height: 70px; width: 410px;
            font-family: 'KccHanbit', sans-serif;
            margin-top: 10px;

            /* so-called 캔디 버튼 */
            background: /*linear-gradient(145deg, #ffb6f0, #ffd166);*/
            linear-gradient(145deg, #3ca7ff, #ffb6f0);
            border: none;
            border-radius: 999px;
            padding: 14px 32px;
            font-size: /*18px*/ 1.0rem;
            font-weight: normal;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2), inset 0 4px 8px rgba(255,255,255,0.5);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .answer1:hover, .answer2:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.25), inset 0 4px 8px rgba(255,255,255,0.6);
        }
        .answer1:active, .answer2:active {
            transform: translateY(2px);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        

        
        .answer_box .selected { /* 선택된 답변 스타일 */
            transform: translateY(2px);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* background_img */
        .question_img {
            /*border:1px solid black;*/
            background: url('images/corridor_school01.png') no-repeat;
            background-size: auto;
            position: fixed;
            bottom: 50%; left: 50%;
            transform: translate(-50%, 50%);
            /*width: 100%; height: auto;*/
            width: 1340px;
            height: 895px;
            z-index: -1;
        }
    </style>
</head>
<body>

    <!-- 질문 섹션 -->
    <section class="question_section">
        <div class="question_box box">
            <div class="question_board">
                <div class="question_progress">
                    <div class="progress_bar">
                        <div class="progress_fill"><!--<div class="progress_grad"></div>--></div>
                    </div>
                    <h4>1/3</h4>                    <!-- 임시로 3문제까지 -->
                </div>
                <div class="question_content">
                    <h3>쉬는 시간의 나의 모습은?</h3>
                </div>
            </div>
        </div>
        <form>
            <div class="answer_box box">
                <input type="hidden" class="question_num" value=""/>       <!-- DB에 저장된 질문번호 -->
                <button type="button" class="answer1">친구들과 수다</button>
                <input type="hidden" name="answer1" value=""/>             <!-- DB에 저장된 답변태그1 -->
                <button type="button" class="answer2">혼자서 책 읽기</button>
                <input type="hidden" name="answer2" value=""/>             <!-- DB에 저장된 답변태그2 -->
                <div class="next_box">
                    <button type="submit" class="next_button" disabled>다음으로</button>
                </div>
            </div>
        </form> 
        <div class="question_img">
        </div>
        <!--<div class="background_img"></div>-->
    </section>
    <!-- /질문 섹션 -->

    <script>
        
        let name = '';
        let AnswerMap = new Map(); // 질문 번호와 답변을 저장할 Map
        let test_num = 0;      // 현재 질문 번호
        const total_questions = 3; // 총 질문 수 (임시로 3문제로 설정)

        /* 이벤트 리스너 */


        /// 초기 화면 ///

        // 테스트 시작하기 클릭 시 
        $('#start_form').on('submit', (e) => {
            e.preventDefault();
            name = $('input[name="name"]').val();
            if(name.length < 1) {                   // 이름 유효성 검사
                alert('이름을 입력해주세요.');
                return;
            }
            // 테스트 시작
            $('.starting_section').css('display', 'none');
            $('.question_section').css('display', 'block');

            // 질문 번호 초기화
            test_num = 1;
            $('.question_box h4').text(test_num + '/' + total_questions);
            progressBarUpdate(test_num - 1); // 진행 바 업데이트 함수 호출
            processNextQuestion(null);   // 첫 질문 처리 함수 호출 (답변 없음)

        }); // form submit


        const $modal = $(".modal");

        // 로그인 버튼 클릭 시 모달 창 열기
        $(".login_button").on('click', () => {
        	$modal.css('display', 'flex');
        });

        // 모달 창 닫기
        $('.close').on('click', () => {
        	$modal.css('display', 'none');
        });

        // 모달 창 외부 클릭 시 닫기
        $(window).on('click', (e) => {
        	if(e.target === $modal[0]) {
        		$modal.css('display', 'none');
        	}
        });
        /*----------------------------------------------------------------*/

        
        /// 질문 화면 ///

        // 답변 버튼 클릭 시 선택한 답변에 스타일 적용
        $(document).on('click', '.answer_box>button', function() {
            $('.answer_box button').removeClass('selected');
            $(this).addClass('selected');
            $('.next_button').prop('disabled', false); // 다음 버튼 활성화
        });

        // 다음 버튼 클릭 시
        $(document).on('click', '.next_button', (e) => {
            e.preventDefault();
            let selected_answer = $('.answer_box .selected').attr("class") == "answer1 selected" ? 'answer1' : 
                                  $('.answer_box .selected').attr("class") == "answer2 selected" ? 'answer2' : null;
            if(selected_answer == null) {          // 선택한 답변 유효성 검사
                alert('답변을 선택해주세요.');
                return;
            }
            saveAnswer(selected_answer);             // 답변 저장 함수 호출
            $('.answer_box button').removeClass('selected');                // 선택 스타일 초기화
            $('.next_button').prop('disabled', true); // 다음 버튼 비활성화

            // 다음 질문으로 넘어가기
            test_num = parseInt($('.question_box h4').text().split('/')[0]);
            if(test_num < total_questions) {     // 임시로 3문제까지
                test_num++;
                $('.question_box h4').text(test_num + '/' + total_questions);
                progressBarUpdate(test_num - 1); // 진행 바 업데이트 함수 호출
                processNextQuestion(selected_answer);   // 다음 질문 처리 함수 호출 (현재의 답변에 따라 다음 질문 불러오기)
            }else{
                progressBarUpdate(total_questions); // 진행 바 100%로 업데이트
                
                alert('테스트가 완료되었습니다.');
                console.log('최종 답변 맵:', AnswerMap);
                
                ////////// 여기서 서버로 답변 맵 전송하는 코드 추가 가능 //////////
                // 예: AJAX 요청을 통해 서버에 AnswerMap 전송

                location.href = 'gamepage_result.html'; // 결과 페이지로 이동
            }

            console.log('질문 번호:', $('.question_box h4').text().split('/')[0]);
            console.log('선택한 답변:', selected_answer);
            console.log('답변 맵:', AnswerMap);

        }); // next_button click

        /*--------------------------------------------------------------*/

        
        




        /* 함수 정의 */

        // 답변 저장 함수
        function saveAnswer(selected_answer) {
            let question_num = $('.question_num').val();
            let answer_tag = $(`.answer_box input[name="${selected_answer}"]`).val();
            AnswerMap.set(question_num, answer_tag);
        }

        // 진행 바 업데이트 함수
        function progressBarUpdate(test_num) {
            let progress_percent = test_num / total_questions;
            document.querySelector('.progress_fill').style.setProperty('--p', progress_percent);
        }

        // 다음 질문 처리 함수
        function processNextQuestion(selected_answer) {

            ///////// 여기에 다음 질문을 불러오는 로직 추가 /////////

            // 예: AJAX 요청을 통해 서버에서 다음 질문과 답변 태그를 받아와서 업데이트
            // 현재는 예시로 질문과 답변을 하드코딩
            let next_question = "다음 질문 예시입니다.";
            let next_answer1 = "다음 답변1 예시";
            let next_answer2 = "다음 답변2 예시";
            let next_question_num = 3;          // 다음 질문 번호
            let next_tag1 = "next_tag1";       // 다음 답변 태그1
            let next_tag2 = "next_tag2";       // 다음 답변 태그2

            // 화면 업데이트
            $('.question_box h3').text(next_question);
            $('.answer_box .answer1').text(next_answer1);
            $('.answer_box .answer2').text(next_answer2);
            $('.question_num').val(next_question_num);
            $('.answer_box input[name="answer1"]').val(next_tag1); 
            $('.answer_box input[name="answer2"]').val(next_tag2);
        }

    </script>
</body>
</html>